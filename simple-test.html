<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
        }
        input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        #console {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>ðŸ§ª Login Test Page</h1>
    
    <div id="message"></div>
    
    <h2>Sign Up</h2>
    <form id="signup-form">
        <div class="form-group">
            <label>Name:</label>
            <input type="text" id="signup-name" value="Test User" required>
        </div>
        <div class="form-group">
            <label>Email:</label>
            <input type="email" id="signup-email" value="test@example.com" required>
        </div>
        <div class="form-group">
            <label>Password:</label>
            <input type="password" id="signup-password" value="password123" required>
        </div>
        <button type="submit">Sign Up</button>
    </form>

    <h2>Sign In</h2>
    <form id="signin-form">
        <div class="form-group">
            <label>Email:</label>
            <input type="email" id="signin-email" value="test@example.com" required>
        </div>
        <div class="form-group">
            <label>Password:</label>
            <input type="password" id="signin-password" value="password123" required>
        </div>
        <button type="submit">Sign In</button>
    </form>

    <h2>Console Output</h2>
    <div id="console"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="db.js?v=3"></script>
    <script src="auth.js?v=3"></script>
    <script src="cloud-db.js?v=3"></script>
    <script src="app.js?v=3"></script>

    <script>
        let authManager;
        let cloudDb;
        let journal;

        function log(message, type = 'info') {
            const consoleEl = document.getElementById('console');
            const time = new Date().toLocaleTimeString();
            consoleEl.innerHTML += `<div>[${time}] ${type.toUpperCase()}: ${message}</div>`;
            consoleEl.scrollTop = consoleEl.scrollHeight;
            console.log(`[${type}]`, message);
        }

        function showMessage(message, type) {
            const messageEl = document.getElementById('message');
            messageEl.className = `message ${type}`;
            messageEl.textContent = message;
        }

        // Initialize
        (async () => {
            try {
                log('Initializing AuthManager...');
                authManager = new AuthManager();
                await authManager.init();
                log('AuthManager initialized', 'success');

                // Check if already authenticated
                if (authManager.isAuthenticated()) {
                    log('User already authenticated: ' + authManager.getCurrentUser().email, 'success');
                    await initApp();
                } else {
                    log('No user authenticated');
                }
            } catch (error) {
                log('Initialization error: ' + error.message, 'error');
                showMessage('Initialization failed: ' + error.message, 'error');
            }
        })();

        // Sign Up
        document.getElementById('signup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;

            log(`Attempting signup: ${email}`);
            showMessage('Signing up...', 'info');

            try {
                const result = await authManager.signUp(email, password, name);
                
                if (result.success) {
                    log('Signup successful!', 'success');
                    showMessage('Signup successful! You can now sign in.', 'success');
                } else {
                    log('Signup failed: ' + result.error, 'error');
                    showMessage('Signup failed: ' + result.error, 'error');
                }
            } catch (error) {
                log('Signup error: ' + error.message, 'error');
                showMessage('Signup error: ' + error.message, 'error');
            }
        });

        // Sign In
        document.getElementById('signin-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('signin-email').value;
            const password = document.getElementById('signin-password').value;

            log(`Attempting signin: ${email}`);
            showMessage('Signing in...', 'info');

            try {
                const result = await authManager.signIn(email, password);
                
                if (result.success) {
                    log('Signin successful!', 'success');
                    showMessage('Signin successful! Initializing app...', 'success');
                    await initApp();
                } else {
                    log('Signin failed: ' + result.error, 'error');
                    showMessage('Signin failed: ' + result.error, 'error');
                }
            } catch (error) {
                log('Signin error: ' + error.message, 'error');
                showMessage('Signin error: ' + error.message, 'error');
            }
        });

        async function initApp() {
            try {
                log('Initializing CloudDB...');
                cloudDb = new CloudDB(authManager);
                await cloudDb.init();
                log('CloudDB initialized', 'success');

                log('Creating FitnessJournal...');
                journal = new FitnessJournal();
                journal.db = cloudDb;
                log('FitnessJournal created', 'success');

                log('Initializing journal...');
                await journal.init();
                log('Journal initialized successfully!', 'success');
                
                showMessage('App initialized! Check console for details.', 'success');
            } catch (error) {
                log('App initialization error: ' + error.message, 'error');
                log('Stack: ' + error.stack, 'error');
                showMessage('App initialization failed: ' + error.message, 'error');
            }
        }

        // Capture console errors
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            log(`Error: ${msg} at ${url}:${lineNo}:${columnNo}`, 'error');
            if (error) log('Stack: ' + error.stack, 'error');
            return false;
        };
    </script>
</body>
</html>
